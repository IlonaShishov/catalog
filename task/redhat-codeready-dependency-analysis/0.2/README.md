# `redhat-codeready-dependency-analysis`
**Please Note: this Task is only compatible with Tekton Pipelines versions 0.19.0 and greater!**

## Overview
The redhat-codeready-dependency-analysis task is an interface between Tekton and Red Hat CodeReady Dependency Analytics platform. 
It provides vulnerability and compliance analysis for your applications dependencies, along with recommendations to address security vulnerabilities and licensing issues.

This task reflects [Dependency Analytics VS Code plugin](https://marketplace.visualstudio.com/items?itemName=redhat.fabric8-analytics) for Tekton Pipelines.

**Please Note: This Task is validated to support Maven ecosystem only**

## Prerequisite

#### 1. Workspace
Workspace is used as a common filesystem between tasks and used for inputs and outputs of task.

This [sample](samples/workspace.yaml) can be referred to in order to create a workspace.<br />

#### 2. Secret
To authenticate a user this task uses CRDA user key. <br />
This key must be generated by the user and saved in secrets. <br />
This is a one time activity to perform. 

Here are the steps to generate a CRDA user key.<br />
1. Install CRDA CLI from [here](https://github.com/fabric8-analytics/cli-tools/releases).
2. Run `crda auth` command, it will assign the user with a unique id which can be found in `~/.crda/config.yaml`. 
Store the value of `crda_key` into a `Secret` to run the task.
<br />
This [sample](samples/secret.yaml) can be referred to in order to create a secret, replace `{{ CRDA_USER_KEY }}` with the generated CRDA key before running.

#### 3. Manifest File
The redhat-codeready-dependency-analysis task scans a manifest file  (ex. pom.xml, src/pom.xml, etc) to collect a list of dependencies. Hence prior to this task, the target application and all its files must be placed into the workspace under a dedicated application directory. 
The path to manifest itself (parent pom.xml) is passed as a parameter to the task.

## Task Parameters
- **manifest-file-path**: Path of target manifest file to perform analysis. `(default: pom.xml)`
- **output-file-name**: Path of the file to save analysis report. `(default: redhat-codeready-dependency-analysis-report.json)`
- **pkg-installation-directory**: Path of a directory in workspace, where application resources are downloaded. `(default: application-package)`
- **image**: Image where CRDA CLI binary and required applications are installed. `(default: quay.io/ecosystem-appeng/crda-maven:1.0)`. <br />List of images for different ecosystem and versions can be found [here](https://github.com/fabric8-analytics/crda-images/blob/main/README.md)
- **CRDA_HOST_URL**: CRDA host, adjust this if you are using an on premise CRDA environment. `(default: "")`

## Sample Output

Task results are saved in JSON format inside the workspace directory. 
```
{
  "report": {
    "total_scanned_dependencies": 2,
    "total_scanned_transitives": 6,
    "total_vulnerabilities": 61,
    "publicly_available_vulnerabilities": 60,
    "vulnerabilities_unique_to_synk": 1,
    "direct_vulnerable_dependencies": 1,
    "low_vulnerabilities": 2,
    "medium_vulnerabilities": 4,
    "high_vulnerabilities": 55,
    "critical_vulnerabilities": 0,
    "report_link": "https://recommender.api.openshift.io/api/v2/stack-report/3c7368e470b94d66bc26f46db163d1e9"
  },
  "exit_code": "2"
}

```
This JSON data provides details of dependency vulnerabilities and a link to view a detailed report. This JSON will be inspected by the next task to make a decision to Fail/Pass the build.  

In the logs, a simplified report will be shown:

```
==================================================
RedHat Dependency Analysis Report
==================================================
Total Scanned Dependencies            :  2 
Total Scanned Transitive Dependencies :  6 
Total Vulnerabilities                 :  61 
Direct Vulnerable Dependencies        :  1 
Publicly Available Vulnerabilities    :  60 
Vulnerabilities Unique to Snyk        :  1 
Critical Vulnerabilities              :  0 
High Vulnerabilities                  :  55 
Medium Vulnerabilities                :  4 
Low Vulnerabilities                   :  2 
==================================================

Open this link to see detailed report:
https://recommender.api.openshift.io/api/v2/stack-report/d8eec32025f145efb2789c61b3111744 


Report is saved into file: redhat-codeready-dependency-analysis-report.json
Task is completed.
```

The link to a detailed report will take users to a browser window with similar format as [Dependency Analytics VS Code plugin](https://marketplace.visualstudio.com/items?itemName=redhat.fabric8-analytics). <br /> To view premium vulnerability data (users can register with Snyk token).

![Alt Text](https://raw.githubusercontent.com/fabric8-analytics/fabric8-analytics-vscode-extension/master/images/0.3.0/reg-stack-analysis.gif)

## Install the Task
```
kubectl apply -f https://api.hub.tekton.dev/v1/resource/tekton/task/redhat-codeready-dependency-analysis/0.2/raw -n <NAMESPACE>
```

## Platforms

The Task can be run on `linux/amd64` platform.

## Usage

The following PipelineRun and TaskRun demonstrate usage of the Task. Please configure the required components like workspace, secrets and tasks from the YAMLs provided in the `samples` directory:

- [Execute redhat-codeready-dependency-analysis task in an end to end pipeline](samples/pipeline-run.yaml)
- [Execute stand alone redhat-codeready-dependency-analysis task](samples/task-run.yaml)
